# 房价统计页面功能更新说明

## 📋 更新概述

本次更新新增了一个独立的房价统计分析页面（`house_stat.html`），提供了强大的历史房价数据统计、可视化和多地区对比功能。

**更新日期**: 2025-12-25  
**版本**: v1.1.0  
**分支**: dev

---

## ✨ 新增功能

### 1. 房价统计页面 (`house_stat.html`)

#### 1.1 页面布局
- **上下结构设计**: 查询条件在上方，统计结果在下方，布局清晰
- **全宽展示**: 最大宽度 1400px，充分利用屏幕空间
- **响应式设计**: 自适应不同屏幕尺寸

#### 1.2 查询模式

**📍 单地区查询模式**
- 选择单个城市或商圈
- 支持精确到月份的时间范围选择（年份 + 月份下拉框）
- 查询指定时间段内的历史均价数据

**📊 多地区对比模式**
- **多城市对比**: 使用复选框勾选多个城市（至少2个）
- **多商圈对比**: 在同一城市内勾选多个商圈（至少2个）
- 横向对比不同地区的房价数据

#### 1.3 数据可视化

提供 4 种可视化方式：

**📊 柱状图**
- 单地区: 展示单价和总价的双Y轴柱状图
- 多地区: 分组柱状图，不同地区并排对比

**📈 折线图**
- 单地区: 双折线展示单价和总价趋势
- 多地区: 多折线对比不同地区的价格走势

**📉 面积图**（原箱线图）
- 单地区: 展示价格上限、平均值、下限的带状区域
- 多地区: 多个带状区域重叠显示，直观对比价格波动范围
- 特点: 
  - 带状区域越窄表示价格越稳定
  - 带状区域越宽表示价格波动越大
  - 可以同时看到价格水平和波动情况

**📋 数据表**
- 单地区: 显示年月、平均单价、平均总价、样本数量
- 多地区: 动态表头，每个地区占两列（单价、总价）

#### 1.4 时间精度

- **月度统计**: 从按年度统计升级为按月度统计
- **时间选择**: 年份下拉框 + 月份下拉框
- **默认范围**: 2023年1月 至 2025年12月
- **横坐标**: 显示完整的年-月格式（如 2023-01、2023-02...）
- **数据点**: 最多可显示 36 个月的数据点，趋势更清晰

---

## 🗂️ 文件清单

### 新增文件

```
frontend/
├── house_stat.html          # 房价统计页面 HTML
└── js/
    └── house_stat.js        # 房价统计页面 JavaScript 逻辑

backend/
└── statistics.py            # 后端统计模块（历史均价计算）

docs/
└── FEATURE_STATISTICS_PAGE.md  # 本文档
```

### 修改文件

```
frontend/
├── index.html               # 添加"房价统计"导航链接
└── js/
    └── app.js              # 添加 i18n 翻译条目

backend/
└── app.py                  # 添加统计相关 API 路由
```

---

## 🔌 API 接口

### 1. 获取历史均价统计

**端点**: `GET /api/historical_avg_price`

**参数**:
- `city` (必填): 城市代码（如 beijing, shanghai）
- `bizcircle` (可选): 商圈名称
- `start_month` (可选): 起始月份，格式 YYYY-MM（默认 2023-01）
- `end_month` (可选): 结束月份，格式 YYYY-MM（默认 2025-12）
- `start_year` (可选): 起始年份（兼容旧版，优先使用 start_month）
- `end_year` (可选): 结束年份（兼容旧版，优先使用 end_month）

**返回数据**:
```json
{
  "ok": true,
  "source": "mysql",
  "city": "beijing",
  "bizcircle": "中关村",
  "data": [
    {
      "year": 2023,
      "month": 1,
      "year_month": "2023-01",
      "avg_unit_price_yuan_sqm": 85000,
      "avg_total_price_wan": 650.5,
      "count": 234
    },
    ...
  ]
}
```

### 2. 获取商圈列表

**端点**: `GET /api/bizcircles`

**参数**:
- `city` (必填): 城市代码

**返回数据**:
```json
{
  "city": "beijing",
  "bizcircles": ["中关村", "国贸", "望京", ...]
}
```

---

## 💻 技术实现

### 前端技术栈

- **原生 JavaScript**: 无框架依赖，纯 JS 实现
- **Chart.js 4.4.1**: 图表可视化库
- **HTML5**: 语义化标签
- **CSS3**: 现代化样式，支持渐变、动画

### 后端技术栈

- **Flask**: Python Web 框架
- **SQLAlchemy**: ORM 数据库操作
- **MySQL**: 主数据源
- **JSON 文件**: 数据库不可用时的回退方案

### 数据统计逻辑

**数据库模式**:
```python
# 按年月分组统计
SELECT 
    YEAR(deal_date) as year,
    MONTH(deal_date) as month,
    AVG(unit_price_yuan_sqm) as avg_unit,
    AVG(total_price_wan) as avg_total,
    COUNT(*) as count
FROM transactions
WHERE city_code = ? 
  AND deal_date >= ?
  AND deal_date <= ?
  AND bizcircle = ?  -- 可选
GROUP BY year, month
ORDER BY year, month
```

**JSON 文件模式**:
- 读取 `data/crawl_history_{city}.json`
- 按年月分桶累加
- 计算平均值

---

## 🎨 UI/UX 特点

### 视觉设计

- **深色主题**: 科技感十足的深色背景
- **渐变色**: 紫色到青色的渐变配色
- **半透明效果**: 毛玻璃效果（backdrop-filter）
- **动画效果**: 按钮悬停、图表过渡动画

### 交互设计

- **复选框多选**: 替代 Ctrl+多选，更直观
- **悬停高亮**: 复选框项悬停时背景变亮
- **即时反馈**: Toast 提示、加载状态显示
- **图表切换**: 一键切换不同可视化方式

### 响应式适配

- **网格布局**: 复选框自动排列成多列
- **滚动区域**: 城市/商圈列表超出可滚动
- **弹性布局**: 按钮自动换行

---

## 📊 数据展示示例

### 单地区查询示例

**查询**: 北京市中关村商圈，2023-01 至 2025-12

**柱状图**: 展示每月的平均单价和总价
**折线图**: 展示价格趋势变化
**面积图**: 展示价格波动范围（上限、平均、下限）
**数据表**: 36 行数据，每行显示年月、单价、总价、样本数

### 多地区对比示例

**查询**: 北京、上海、深圳三城市对比，2023-01 至 2025-12

**柱状图**: 三种颜色的柱子并排显示
**折线图**: 三条折线展示不同城市的价格走势
**面积图**: 三个带状区域重叠，直观对比价格水平和波动
**数据表**: 表头动态生成，每个城市占两列

---

## 🔧 配置说明

### 时间范围配置

在 `house_stat.html` 中修改默认时间范围：

```html
<!-- 单地区模式 -->
<select id="stat-start-year">
    <option value="2023">2023</option>
    <!-- 添加更多年份 -->
</select>

<!-- 月份选项 -->
<select id="stat-start-month">
    <option value="01" selected>1月</option>
    <!-- 1-12月 -->
</select>
```

### 图表配置

在 `house_stat.js` 中调整图表样式：

```javascript
// 修改颜色
backgroundColor: 'rgba(121, 97, 255, 0.7)',
borderColor: 'rgba(121, 97, 255, 1)',

// 修改图表高度
height: 500px  // 在 HTML 中修改

// 修改标准差系数（面积图波动范围）
const spread = Math.sqrt(count) * 800;  // 调整 800 这个系数
```

---

## 🐛 已知问题

无

---

## 🚀 未来优化方向

1. **更多图表类型**: 雷达图、热力图等
2. **数据导出**: 支持导出 Excel、CSV
3. **自定义时间范围**: 支持任意日期选择
4. **数据缓存**: 前端缓存已查询数据
5. **打印功能**: 支持打印报表
6. **分享功能**: 生成分享链接

---

## 📝 使用说明

### 单地区查询

1. 点击导航栏的"房价统计"
2. 保持"📍 单地区查询"模式
3. 选择城市
4. （可选）选择商圈
5. 选择起始年份和月份
6. 选择结束年份和月份
7. 点击"查询历史均价"
8. 查看图表或数据表

### 多城市对比

1. 点击"📊 多地区对比"按钮
2. 选择"多城市对比"
3. 勾选至少 2 个城市
4. 选择时间范围
5. 点击"开始对比"
6. 查看对比图表

### 多商圈对比

1. 点击"📊 多地区对比"按钮
2. 选择"同城市多商圈对比"
3. 选择城市
4. 勾选至少 2 个商圈
5. 选择时间范围
6. 点击"开始对比"
7. 查看对比图表

---

## 🔍 测试建议

### 功能测试

- [ ] 单地区查询（不同城市、商圈）
- [ ] 多城市对比（2-6 个城市）
- [ ] 多商圈对比（2-10 个商圈）
- [ ] 时间范围选择（不同年月组合）
- [ ] 图表切换（4 种类型）
- [ ] 重置功能
- [ ] 响应式布局（不同屏幕尺寸）

### 性能测试

- [ ] 大量数据点渲染（36 个月）
- [ ] 多地区对比（6 个地区）
- [ ] 图表切换速度
- [ ] 并发查询（多个地区同时请求）

### 兼容性测试

- [ ] Chrome 90+
- [ ] Firefox 88+
- [ ] Safari 14+
- [ ] Edge 90+

---

## 👥 贡献者

- 开发者: [Your Name]
- 设计: [Your Name]
- 测试: [Your Name]

---

## 📄 许可证

本项目遵循原项目的许可证。
